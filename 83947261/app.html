<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0a0a0b">
  <title>Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --font: 'Space Grotesk', system-ui, sans-serif;
      --mono: 'JetBrains Mono', monospace;
      --bg: linear-gradient(165deg, #0a0a0b 0%, #0f1419 50%, #0a0a0b 100%);
      --glass: rgba(255,255,255,0.03);
      --glass-border: rgba(255,255,255,0.06);
      --glass-hover: rgba(255,255,255,0.06);
      --text: #ffffff;
      --text-dim: rgba(255,255,255,0.6);
      --text-muted: rgba(255,255,255,0.35);
      --blue: #3b82f6;
      --blue-glow: rgba(59,130,246,0.4);
      --green: #22c55e;
      --green-glow: rgba(34,197,94,0.4);
      --amber: #f59e0b;
      --red: #ef4444;
      --purple: #a855f7;
    }
    html { font-size: 15px; }
    body { font-family: var(--font); background: var(--bg); background-attachment: fixed; color: var(--text); min-height: 100vh; overflow-x: hidden; }

    /* Ambient glow */
    .glow { position: fixed; width: 600px; height: 600px; border-radius: 50%; pointer-events: none; opacity: 0.15; filter: blur(120px); z-index: 0; }
    .glow-1 { top: -200px; left: -100px; background: var(--blue); }
    .glow-2 { bottom: -300px; right: -100px; background: var(--purple); }

    .app { position: relative; z-index: 1; min-height: 100vh; }

    /* Header */
    .header { padding: 20px 32px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 50; background: rgba(10,10,11,0.8); }
    .brand { display: flex; align-items: center; gap: 24px; }
    .logo { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.03em; }
    .logo span { background: linear-gradient(135deg, var(--blue), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .sprint-tag { display: flex; align-items: center; gap: 12px; padding: 8px 16px; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 100px; }
    .sprint-tag .name { font-size: 0.8125rem; color: var(--text-dim); font-weight: 500; }
    .sprint-tag .days { font-family: var(--mono); font-size: 0.875rem; font-weight: 500; color: var(--blue); }
    .header-actions { display: flex; gap: 8px; }
    .icon-btn { width: 40px; height: 40px; border-radius: 12px; border: 1px solid var(--glass-border); background: var(--glass); color: var(--text-dim); font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; backdrop-filter: blur(10px); }
    .icon-btn:hover { background: var(--glass-hover); border-color: rgba(255,255,255,0.12); color: var(--text); transform: translateY(-1px); }
    .icon-btn.active { background: var(--blue); border-color: var(--blue); color: white; box-shadow: 0 0 20px var(--blue-glow); }

    /* Main Grid */
    .main { max-width: 1400px; margin: 0 auto; padding: 32px; display: grid; grid-template-columns: 380px 1fr; gap: 32px; }
    @media (max-width: 1000px) { .main { grid-template-columns: 1fr; padding: 20px; } }

    /* Section Label */
    .section-label { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .section-label .title { font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); }
    .section-label .count { font-family: var(--mono); font-size: 0.75rem; color: var(--text-muted); padding: 4px 10px; background: var(--glass); border-radius: 6px; }
    .section-label .icon { font-size: 0.875rem; }

    /* Glass Card */
    .glass-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 20px; overflow: hidden; }
    .glass-card.sprint { border-color: rgba(59,130,246,0.2); background: linear-gradient(135deg, rgba(59,130,246,0.08) 0%, var(--glass) 100%); }

    /* Task List */
    .task-list { max-height: 450px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.1) transparent; }
    .task-list::-webkit-scrollbar { width: 4px; }
    .task-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

    /* Task Row */
    .task { display: flex; align-items: center; gap: 14px; padding: 16px 20px; border-bottom: 1px solid var(--glass-border); transition: all 0.15s ease; }
    .task:last-child { border-bottom: none; }
    .task:hover { background: var(--glass-hover); }
    .task-indicator { width: 4px; height: 32px; border-radius: 2px; flex-shrink: 0; }
    .task-body { flex: 1; min-width: 0; }
    .task-text { font-size: 0.9375rem; font-weight: 500; color: var(--text); line-height: 1.4; letter-spacing: -0.01em; }
    .task-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 3px; display: flex; align-items: center; gap: 8px; }
    .task-sub .cat { color: var(--text-dim); }
    .task-sub .overdue { color: var(--red); }
    .task-sub .due { color: var(--amber); }
    .task-actions { display: flex; gap: 8px; flex-shrink: 0; }

    /* Buttons */
    .btn { padding: 8px 14px; border-radius: 10px; border: none; font-family: var(--font); font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 5px; }
    .btn-done { background: rgba(34,197,94,0.1); color: var(--green); border: 1px solid rgba(34,197,94,0.2); }
    .btn-done:hover { background: var(--green); color: white; box-shadow: 0 0 20px var(--green-glow); transform: translateY(-1px); }
    .btn-done.checked { background: var(--green); color: white; }
    .btn-activate { background: rgba(59,130,246,0.1); color: var(--blue); border: 1px solid rgba(59,130,246,0.2); }
    .btn-activate:hover { background: var(--blue); color: white; box-shadow: 0 0 20px var(--blue-glow); transform: translateY(-1px); }

    /* Empty State */
    .empty { padding: 48px 24px; text-align: center; }
    .empty-icon { font-size: 2rem; margin-bottom: 12px; opacity: 0.3; }
    .empty-text { color: var(--text-muted); font-size: 0.875rem; }

    /* Right Column */
    .right-col { display: flex; flex-direction: column; gap: 32px; }

    /* Backlog Grid */
    .backlog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
    .category { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 16px; overflow: hidden; }
    .category-head { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--glass-border); }
    .category-bar { width: 3px; height: 18px; border-radius: 2px; }
    .category-name { flex: 1; font-size: 0.8125rem; font-weight: 600; color: var(--text); }
    .category-num { font-family: var(--mono); font-size: 0.6875rem; color: var(--text-muted); }
    .category-list { max-height: 200px; overflow-y: auto; }
    .cat-task { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--glass-border); transition: background 0.15s; }
    .cat-task:last-child { border-bottom: none; }
    .cat-task:hover { background: var(--glass-hover); }
    .cat-task-text { flex: 1; font-size: 0.8125rem; color: var(--text-dim); line-height: 1.4; }
    .cat-task-due { font-size: 0.6875rem; color: var(--text-muted); margin-top: 2px; }
    .cat-task-due.warn { color: var(--amber); }

    /* Edit Mode */
    .edit-box { width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--glass-border); background: transparent; display: none; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; color: transparent; font-size: 0.625rem; transition: all 0.15s; }
    .edit-mode .edit-box { display: flex; }
    .edit-mode .task-actions { display: none; }
    .edit-box:hover { border-color: var(--blue); }
    .edit-box.on { background: var(--blue); border-color: var(--blue); color: white; box-shadow: 0 0 12px var(--blue-glow); }
    .edit-bar { position: fixed; bottom: 0; left: 0; right: 0; padding: 16px 32px; display: none; justify-content: center; gap: 12px; z-index: 100; background: rgba(10,10,11,0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--glass-border); }
    .edit-mode .edit-bar { display: flex; }
    .bar-btn { padding: 12px 24px; border-radius: 12px; border: none; font-family: var(--font); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .bar-btn.cancel { background: var(--glass); color: var(--text-dim); border: 1px solid var(--glass-border); }
    .bar-btn.cancel:hover { background: var(--glass-hover); color: var(--text); }
    .bar-btn.done { background: var(--green); color: white; }
    .bar-btn.done:hover { box-shadow: 0 0 24px var(--green-glow); transform: translateY(-2px); }
    .bar-btn.activate { background: var(--blue); color: white; }
    .bar-btn.activate:hover { box-shadow: 0 0 24px var(--blue-glow); transform: translateY(-2px); }

    /* Dropdown */
    .dropdown { position: relative; }
    .dropdown-menu { position: absolute; top: calc(100% + 8px); right: 0; min-width: 150px; background: rgba(20,20,25,0.95); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 12px; padding: 6px; opacity: 0; visibility: hidden; transform: translateY(-8px); transition: all 0.2s; z-index: 200; }
    .dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .dropdown-item { display: block; width: 100%; padding: 10px 12px; font-size: 0.8125rem; font-family: var(--font); color: var(--text-dim); background: none; border: none; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.15s; }
    .dropdown-item:hover { background: var(--glass-hover); color: var(--text); }

    /* Toast */
    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(16px); background: rgba(20,20,25,0.95); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); padding: 12px 24px; border-radius: 12px; font-size: 0.875rem; font-weight: 500; color: var(--text); opacity: 0; visibility: hidden; transition: all 0.25s; z-index: 1000; }
    .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .edit-mode .toast { bottom: 88px; }

    /* Colors */
    .ind-leadlink, .bar-leadlink { background: #3b82f6; }
    .ind-medivault, .bar-medivault { background: #10b981; }
    .ind-writing, .bar-writing { background: #8b5cf6; }
    .ind-errands, .bar-errands { background: #f59e0b; }
    .ind-general, .bar-general { background: #64748b; }
    .ind-eveready, .bar-eveready { background: #ec4899; }
    .ind-proverbs, .bar-proverbs { background: #a855f7; }
    .ind-frame, .bar-frame { background: #f472b6; }
  </style>
</head>
<body>
  <div class="glow glow-1"></div>
  <div class="glow glow-2"></div>
  <div class="app" id="app">
    <header class="header">
      <div class="brand">
        <div class="logo">Untitled<span>Publishers</span></div>
        <div class="sprint-tag">
          <span class="name" id="sprintName">Loading...</span>
          <span class="days"><span id="daysLeft">‚Äì</span> days</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="editBtn" title="Edit">‚úèÔ∏è</button>
        <button class="icon-btn" id="refreshBtn" title="Refresh">‚Üª</button>
        <div class="dropdown">
          <button class="icon-btn" id="menuBtn">‚ò∞</button>
          <div class="dropdown-menu" id="menu">
            <button class="dropdown-item" onclick="location.href='guide.html'">üìñ Guide</button>
            <button class="dropdown-item" onclick="logout()">üö™ Sign Out</button>
          </div>
        </div>
      </div>
    </header>
    <main class="main">
      <div>
        <div class="section-label">
          <span class="title">Active</span>
          <span class="count" id="activeCount">0</span>
        </div>
        <div class="glass-card">
          <div class="task-list" id="activeList"></div>
        </div>
      </div>
      <div class="right-col">
        <div>
          <div class="section-label">
            <span class="icon">üéØ</span>
            <span class="title">Sprint</span>
            <span class="count" id="sprintCount">0</span>
          </div>
          <div class="glass-card sprint">
            <div class="task-list" id="sprintList"></div>
          </div>
        </div>
        <div>
          <div class="section-label">
            <span class="title">Backlog</span>
          </div>
          <div class="backlog-grid" id="backlogGrid"></div>
        </div>
      </div>
    </main>
    <div class="edit-bar">
      <button class="bar-btn cancel" onclick="exitEdit()">Cancel</button>
      <button class="bar-btn done" onclick="doneSelected()">‚úì Complete <span id="selA">0</span></button>
      <button class="bar-btn activate" onclick="activateSelected()">+ Activate <span id="selO">0</span></button>
    </div>
  </div>
  <div class="toast" id="toast"></div>
  <script>
    (function(){if(localStorage.getItem('authenticated')!=='true'||!localStorage.getItem('apiUrl'))location.href='index.html';})();
    const API=localStorage.getItem('apiUrl'),S={edit:false,a:new Set(),s:new Set(),b:new Set()};
    const C={leadlink:'leadlink','lead link':'leadlink',medivault:'medivault',tech:'medivault',writing:'writing','the frame':'frame',proverbs:'proverbs','proverbs library':'proverbs',errands:'errands',eveready:'eveready'};
    const col=c=>{if(!c)return'general';const l=c.toLowerCase();for(const[k,v]of Object.entries(C))if(l.includes(k))return v;return'general';};
    const api=async(p,o={})=>{try{const r=await fetch(API+p,{...o,headers:{'Content-Type':'application/json'}});if(!r.ok)throw 0;return r.json();}catch{toast('Request failed');return null;}};
    const load=async()=>{
      const d=await api('/morning');if(!d)return;
      document.getElementById('sprintName').textContent=d.plan?.title||'No Plan';
      document.getElementById('daysLeft').textContent=d.plan?.workDaysRemaining??'‚Äì';
      renderActive(d.activeTasks||[]);
      renderSprint(d.sprintTasks||[]);
      renderBacklog(d.backlogByCategory||{});
    };
    const renderActive=tasks=>{
      document.getElementById('activeCount').textContent=tasks.length;
      const el=document.getElementById('activeList');
      if(!tasks.length){el.innerHTML='<div class="empty"><div class="empty-icon">‚úì</div><div class="empty-text">All clear. Activate tasks from Sprint or Backlog.</div></div>';return;}
      el.innerHTML=tasks.map(t=>{
        const c=col(t.category||t.project);let m='';
        if(t.category)m='<span class="cat">'+esc(t.category)+'</span>';
        if(t.due_date)m+=(m?' ¬∑ ':'')+'<span class="'+(over(t.due_date)?'overdue':'due')+'">'+fmt(t.due_date)+'</span>';
        return'<div class="task"><div class="edit-box'+(S.a.has(t.id)?' on':'')+'" onclick="tog(\'a\',\''+t.id+'\',this)">‚úì</div><div class="task-indicator ind-'+c+'"></div><div class="task-body"><div class="task-text">'+esc(t.text)+'</div>'+(m?'<div class="task-sub">'+m+'</div>':'')+'</div><div class="task-actions"><button class="btn btn-done" onclick="done(\''+t.id+'\',this)">‚úì Done</button></div></div>';
      }).join('');
    };
    const renderSprint=tasks=>{
      document.getElementById('sprintCount').textContent=tasks.length;
      const el=document.getElementById('sprintList');
      if(!tasks.length){el.innerHTML='<div class="empty"><div class="empty-icon">üéØ</div><div class="empty-text">No sprint tasks yet.</div></div>';return;}
      el.innerHTML=tasks.map(t=>{
        const c=col(t.category||t.project);let m='';
        if(t.category)m='<span class="cat">'+esc(t.category)+'</span>';
        if(t.goal_description)m+=(m?' ‚Üí ':'')+esc(t.goal_description);
        if(t.due_date)m+=(m?' ¬∑ ':'')+'<span class="'+(over(t.due_date)?'overdue':'due')+'">'+fmt(t.due_date)+'</span>';
        return'<div class="task"><div class="edit-box'+(S.s.has(t.id)?' on':'')+'" onclick="tog(\'s\',\''+t.id+'\',this)">‚úì</div><div class="task-indicator ind-'+c+'"></div><div class="task-body"><div class="task-text">'+esc(t.text)+'</div>'+(m?'<div class="task-sub">'+m+'</div>':'')+'</div><div class="task-actions"><button class="btn btn-done" onclick="done(\''+t.id+'\',this)">‚úì Done</button><button class="btn btn-activate" onclick="activate(\''+t.id+'\')">+ Active</button></div></div>';
      }).join('');
    };
    const renderBacklog=by=>{
      const el=document.getElementById('backlogGrid'),cats=Object.keys(by);
      if(!cats.length){el.innerHTML='<div class="empty"><div class="empty-text">No backlog tasks.</div></div>';return;}
      el.innerHTML=cats.map(cat=>{
        const tasks=by[cat],c=col(cat);
        return'<div class="category"><div class="category-head"><div class="category-bar bar-'+c+'"></div><div class="category-name">'+esc(cat)+'</div><div class="category-num">'+tasks.length+'</div></div><div class="category-list">'+tasks.map(t=>'<div class="cat-task"><div class="edit-box'+(S.b.has(t.id)?' on':'')+'" onclick="tog(\'b\',\''+t.id+'\',this)">‚úì</div><div class="task-body"><div class="cat-task-text">'+esc(t.text)+'</div>'+(t.due_date?'<div class="cat-task-due'+(over(t.due_date)?' warn':'')+'">'+fmt(t.due_date)+'</div>':'')+'</div><div class="task-actions"><button class="btn btn-activate" onclick="activate(\''+t.id+'\')">+ Active</button></div></div>').join('')+'</div></div>';
      }).join('');
    };
    const done=async(id,el)=>{el.classList.add('checked');el.innerHTML='‚úì';const r=await api('/tasks/'+id+'/complete',{method:'POST'});if(r?.success){toast('Done ‚úì');setTimeout(load,200);}else{el.classList.remove('checked');el.innerHTML='‚úì Done';}};
    const activate=async id=>{const r=await api('/tasks/'+id+'/activate',{method:'POST'});if(r?.success){toast('Activated');load();}};
    const tog=(t,id,el)=>{const s=t==='a'?S.a:t==='s'?S.s:S.b;s.has(id)?s.delete(id):s.add(id);el.classList.toggle('on');upd();};
    const upd=()=>{document.getElementById('selA').textContent=S.a.size;document.getElementById('selO').textContent=S.s.size+S.b.size;};
    const toggleEdit=()=>{S.edit=!S.edit;document.getElementById('app').classList.toggle('edit-mode',S.edit);document.getElementById('editBtn').classList.toggle('active',S.edit);if(!S.edit){S.a.clear();S.s.clear();S.b.clear();upd();}};
    const exitEdit=()=>{S.edit=false;S.a.clear();S.s.clear();S.b.clear();document.getElementById('app').classList.remove('edit-mode');document.getElementById('editBtn').classList.remove('active');load();};
    const doneSelected=async()=>{if(!S.a.size){toast('Select active tasks');return;}let n=0;for(const id of S.a){const r=await api('/tasks/'+id+'/complete',{method:'POST'});if(r?.success)n++;}toast(n+' completed');exitEdit();};
    const activateSelected=async()=>{const ids=[...S.s,...S.b];if(!ids.length){toast('Select tasks');return;}let n=0;for(const id of ids){const r=await api('/tasks/'+id+'/activate',{method:'POST'});if(r?.success)n++;}toast(n+' activated');exitEdit();};
    const toast=m=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);};
    const logout=()=>{localStorage.clear();location.href='index.html';};
    const fmt=s=>s?new Date(s).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';
    const over=s=>{if(!s)return false;const d=new Date(s),t=new Date();t.setHours(0,0,0,0);return d<t;};
    const esc=s=>s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):'';
    document.getElementById('editBtn').onclick=toggleEdit;
    document.getElementById('refreshBtn').onclick=()=>{load();toast('Refreshed');};
    document.getElementById('menuBtn').onclick=e=>{e.stopPropagation();document.getElementById('menu').classList.toggle('show');};
    document.onclick=e=>{if(!e.target.closest('.dropdown'))document.getElementById('menu').classList.remove('show');};
    load();
  </script>
</body>
</html>