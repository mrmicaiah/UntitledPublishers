<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#09090b">
  <title>Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #09090b;
      --bg-card: #18181b;
      --bg-hover: #27272a;
      --bg-active: #3f3f46;
      --border: rgba(255,255,255,0.06);
      --border-light: rgba(255,255,255,0.03);
      --text: #fafafa;
      --text-secondary: rgba(255,255,255,0.65);
      --text-muted: rgba(255,255,255,0.4);
      
      /* Category colors */
      --leadlink: #3b82f6;
      --leadlink-soft: rgba(59,130,246,0.12);
      --medivault: #22c55e;
      --medivault-soft: rgba(34,197,94,0.12);
      --writing: #a855f7;
      --writing-soft: rgba(168,85,247,0.12);
      --errands: #f59e0b;
      --errands-soft: rgba(245,158,11,0.12);
      --general: #71717a;
      --general-soft: rgba(113,113,122,0.12);
      
      /* Status colors */
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
      
      --radius: 16px;
      --radius-sm: 10px;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }

    /* Sprint Header */
    .header {
      padding: 20px 20px 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .header-left { flex: 1; }

    .sprint-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .sprint-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 2px;
    }

    .sprint-dates {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .days-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: linear-gradient(135deg, var(--leadlink-soft), transparent);
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: 100px;
    }

    .days-number {
      font-family: 'JetBrains Mono', monospace;
      font-size: 22px;
      font-weight: 700;
      color: var(--leadlink);
    }

    .days-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .icon-btn:active { transform: scale(0.95); background: var(--bg-hover); }
    .icon-btn.edit-active { background: var(--leadlink); color: white; border-color: var(--leadlink); }

    /* Main content scroll area */
    .main {
      padding: 0 16px 32px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Section styling */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 0 4px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    /* Goal Rings */
    .goals-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 4px;
      margin: 0 -16px;
      padding-left: 16px;
      padding-right: 16px;
      scrollbar-width: none;
    }
    .goals-scroll::-webkit-scrollbar { display: none; }

    .goal-ring {
      flex-shrink: 0;
      width: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 12px;
      background: var(--bg-card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .goal-ring:active { transform: scale(0.97); background: var(--bg-hover); }

    .ring-container {
      position: relative;
      width: 64px;
      height: 64px;
      margin-bottom: 10px;
    }

    .ring-svg {
      transform: rotate(-90deg);
      width: 64px;
      height: 64px;
    }

    .ring-bg {
      fill: none;
      stroke: var(--bg);
      stroke-width: 6;
    }

    .ring-progress {
      fill: none;
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.4s ease, stroke 0.3s ease;
    }

    .ring-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .ring-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
      font-weight: 700;
      line-height: 1;
    }

    .ring-total {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .goal-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1.3;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    /* Active Now Section */
    .active-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
      background: var(--bg-card);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .task-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-card);
      transition: background 0.15s ease;
    }

    .task-item:not(:last-child) { border-bottom: 1px solid var(--border-light); }
    .task-item:active { background: var(--bg-hover); }

    .task-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .task-dot.leadlink { background: var(--leadlink); }
    .task-dot.medivault { background: var(--medivault); }
    .task-dot.writing { background: var(--writing); }
    .task-dot.errands { background: var(--errands); }
    .task-dot.general { background: var(--general); }

    .task-content { flex: 1; min-width: 0; }

    .task-text {
      font-size: 14px;
      font-weight: 500;
      line-height: 1.4;
      color: var(--text);
    }

    .task-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .task-checkbox {
      width: 24px;
      height: 24px;
      border-radius: 8px;
      border: 2px solid var(--border);
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
      flex-shrink: 0;
      color: transparent;
    }

    .task-checkbox:hover { border-color: var(--success); }
    .task-checkbox.checked { 
      background: var(--success); 
      border-color: var(--success); 
      color: white;
    }

    /* Edit mode checkbox */
    .edit-checkbox {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 2px solid var(--border);
      background: transparent;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .edit-mode .edit-checkbox { display: flex; }
    .edit-mode .task-checkbox { display: none; }

    .edit-checkbox.selected {
      background: var(--leadlink);
      border-color: var(--leadlink);
      color: white;
    }

    /* Backlog Boxes */
    .backlog-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .backlog-box {
      background: var(--bg-card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .backlog-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .backlog-header:active { background: var(--bg-hover); }

    .backlog-color {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .backlog-color.leadlink { background: var(--leadlink); }
    .backlog-color.medivault { background: var(--medivault); }
    .backlog-color.writing { background: var(--writing); }
    .backlog-color.errands { background: var(--errands); }
    .backlog-color.general { background: var(--general); }

    .backlog-name {
      flex: 1;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .backlog-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 100px;
      background: var(--bg);
      color: var(--text-secondary);
    }

    .backlog-tasks {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease;
    }

    .backlog-box.expanded .backlog-tasks {
      max-height: 400px;
    }

    .backlog-task {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-top: 1px solid var(--border-light);
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .backlog-task:active { background: var(--bg-hover); }

    .backlog-task-text {
      flex: 1;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.3;
    }

    .activate-btn {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 1px dashed var(--border);
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .activate-btn:hover {
      border-color: var(--leadlink);
      color: var(--leadlink);
      border-style: solid;
    }

    /* Edit Mode Action Bar */
    .edit-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 20px;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      display: none;
      gap: 12px;
      transform: translateY(100%);
      transition: transform 0.2s ease;
    }

    .edit-mode .edit-bar {
      display: flex;
      transform: translateY(0);
    }

    .edit-btn {
      flex: 1;
      padding: 14px 20px;
      border-radius: var(--radius-sm);
      border: none;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .edit-btn:active { transform: scale(0.98); }

    .edit-btn.done-btn {
      background: var(--success);
      color: white;
    }

    .edit-btn.activate-btn-bar {
      background: var(--leadlink);
      color: white;
    }

    .edit-btn.cancel-btn {
      background: var(--bg);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .selected-count {
      font-family: 'JetBrains Mono', monospace;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 12px 40px rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .edit-mode .toast { bottom: 100px; }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 32px 20px;
      color: var(--text-muted);
    }

    .empty-icon {
      font-size: 28px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .empty-text {
      font-size: 13px;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      gap: 12px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--leadlink);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Guide link */
    .guide-link {
      display: block;
      text-align: center;
      padding: 16px;
      font-size: 12px;
      color: var(--text-muted);
      text-decoration: none;
    }

    .guide-link:hover { color: var(--text-secondary); }

    /* Dropdown menu */
    .dropdown {
      position: relative;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      min-width: 140px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 6px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px) scale(0.95);
      transition: all 0.15s ease;
      z-index: 100;
    }

    .dropdown-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }

    .dropdown-item {
      display: block;
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text-secondary);
      background: none;
      border: none;
      border-radius: 6px;
      text-align: left;
      cursor: pointer;
      font-family: inherit;
    }

    .dropdown-item:hover {
      background: var(--bg-hover);
      color: var(--text);
    }

    /* Animations */
    @keyframes fadeSlideUp {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-in {
      animation: fadeSlideUp 0.3s ease forwards;
    }

    .delay-1 { animation-delay: 0.05s; opacity: 0; }
    .delay-2 { animation-delay: 0.1s; opacity: 0; }
    .delay-3 { animation-delay: 0.15s; opacity: 0; }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-left">
      <div class="sprint-label">Current Sprint</div>
      <div class="sprint-title" id="sprintTitle">Loading...</div>
      <div class="sprint-dates" id="sprintDates"></div>
    </div>
    <div class="days-badge">
      <span class="days-number" id="daysLeft">‚Äì</span>
      <span class="days-label">days<br>left</span>
    </div>
  </header>

  <div class="header-actions" style="position: absolute; top: 20px; right: 20px; display: flex; gap: 8px;">
    <button class="icon-btn" id="editBtn" title="Edit Mode">‚úèÔ∏è</button>
    <div class="dropdown">
      <button class="icon-btn" id="menuBtn">‚ò∞</button>
      <div class="dropdown-menu" id="dropdownMenu">
        <button class="dropdown-item" onclick="refreshData()">‚Üª Refresh</button>
        <button class="dropdown-item" onclick="window.location.href='guide.html'">? Help</button>
        <button class="dropdown-item" onclick="logout()">Sign out</button>
      </div>
    </div>
  </div>

  <main class="main">
    <!-- Goal Rings -->
    <section class="section animate-in delay-1" id="goalsSection">
      <div class="section-header">
        <span class="section-title">Goals</span>
      </div>
      <div class="goals-scroll" id="goalRings">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </section>

    <!-- Active Now -->
    <section class="section animate-in delay-2">
      <div class="section-header">
        <span class="section-title">Active Now</span>
        <span class="section-count" id="activeCount" style="font-size: 11px; color: var(--text-muted);">0</span>
      </div>
      <div class="active-list" id="activeTasks">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </section>

    <!-- Backlog -->
    <section class="section animate-in delay-3">
      <div class="section-header">
        <span class="section-title">Backlog</span>
      </div>
      <div class="backlog-grid" id="backlogGrid"></div>
    </section>

    <a href="guide.html" class="guide-link">Dashboard Guide ‚Üí</a>
  </main>

  <!-- Edit Mode Action Bar -->
  <div class="edit-bar">
    <button class="edit-btn cancel-btn" onclick="exitEditMode()">Cancel</button>
    <button class="edit-btn done-btn" onclick="markSelectedDone()">
      Done (<span class="selected-count" id="activeSelectedCount">0</span>)
    </button>
    <button class="edit-btn activate-btn-bar" onclick="activateSelected()">
      Activate (<span class="selected-count" id="backlogSelectedCount">0</span>)
    </button>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Auth check
    if (localStorage.getItem('authenticated') !== 'true' || !localStorage.getItem('apiUrl')) {
      window.location.href = 'index.html';
    }

    const API_URL = localStorage.getItem('apiUrl');
    const USER_NAME = localStorage.getItem('userName') || 'User';

    // State
    let currentData = null;
    let editMode = false;
    let selectedActive = new Set();
    let selectedBacklog = new Set();
    let expandedCategories = new Set();

    // Category mapping
    const CATEGORY_MAP = {
      'leadlink': 'leadlink',
      'lead link': 'leadlink',
      'medivault': 'medivault',
      'medi vault': 'medivault',
      'writing': 'writing',
      'the frame': 'writing',
      'proverbs': 'writing',
      'sean': 'writing',
      'errands': 'errands',
      'errand': 'errands',
      'general': 'general'
    };

    function getCategoryClass(category) {
      if (!category) return 'general';
      const lower = category.toLowerCase();
      for (const [key, value] of Object.entries(CATEGORY_MAP)) {
        if (lower.includes(key)) return value;
      }
      return 'general';
    }

    // API
    async function api(endpoint, options = {}) {
      try {
        const res = await fetch(`${API_URL}${endpoint}`, {
          ...options,
          headers: { 'Content-Type': 'application/json', ...options.headers }
        });
        if (!res.ok) throw new Error(res.status);
        return await res.json();
      } catch (e) {
        console.error('API Error:', e);
        showToast('Request failed');
        return null;
      }
    }

    // Load data
    async function loadData() {
      const data = await api('/morning');
      if (!data) return;
      currentData = data;

      // Sprint header
      if (data.plan) {
        document.getElementById('sprintTitle').textContent = data.plan.title || 'Sprint';
        document.getElementById('sprintDates').textContent = 
          `${formatDateShort(data.plan.startDate)} ‚Äì ${formatDateShort(data.plan.endDate)}`;
        document.getElementById('daysLeft').textContent = data.plan.workDaysRemaining || 0;
      } else {
        document.getElementById('sprintTitle').textContent = 'No active plan';
        document.getElementById('sprintDates').textContent = '';
        document.getElementById('daysLeft').textContent = '‚Äì';
      }

      // Goals
      renderGoals(data.plan?.goals || []);

      // Active tasks
      renderActiveTasks(data.activeTasks || []);

      // Backlog - group by category
      renderBacklog(data.backlog || []);
    }

    function renderGoals(goals) {
      const container = document.getElementById('goalRings');
      
      if (!goals.length) {
        document.getElementById('goalsSection').style.display = 'none';
        return;
      }

      document.getElementById('goalsSection').style.display = 'block';
      const circumference = 2 * Math.PI * 26;

      container.innerHTML = goals.map(g => {
        const progress = g.targetCount > 0 ? (g.completedCount / g.targetCount) : 0;
        const dashOffset = circumference * (1 - Math.min(progress, 1));
        const color = progress >= 1 ? 'var(--success)' : 
                      progress >= 0.5 ? 'var(--warning)' : 'var(--danger)';

        return `
          <div class="goal-ring" data-goal-id="${g.id}" onclick="incrementGoal('${g.id}')">
            <div class="ring-container">
              <svg class="ring-svg" viewBox="0 0 64 64">
                <circle class="ring-bg" cx="32" cy="32" r="26"/>
                <circle class="ring-progress" cx="32" cy="32" r="26"
                  stroke="${color}"
                  stroke-dasharray="${circumference}"
                  stroke-dashoffset="${dashOffset}"/>
              </svg>
              <div class="ring-center">
                <span class="ring-count">${g.completedCount}</span>
                <span class="ring-total">/ ${g.targetCount}</span>
              </div>
            </div>
            <span class="goal-label">${esc(g.description)}</span>
          </div>
        `;
      }).join('');
    }

    function renderActiveTasks(tasks) {
      const container = document.getElementById('activeTasks');
      document.getElementById('activeCount').textContent = tasks.length;

      if (!tasks.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚úì</div>
            <div class="empty-text">All clear! Tap backlog to activate tasks.</div>
          </div>
        `;
        return;
      }

      container.innerHTML = tasks.map(t => {
        const catClass = getCategoryClass(t.category || t.project);
        return `
          <div class="task-item" data-id="${t.id}">
            <div class="edit-checkbox ${selectedActive.has(t.id) ? 'selected' : ''}" 
                 onclick="toggleActiveSelect('${t.id}', event)">
              ${selectedActive.has(t.id) ? '‚úì' : ''}
            </div>
            <span class="task-dot ${catClass}"></span>
            <div class="task-content">
              <div class="task-text">${esc(t.text)}</div>
              ${t.category || t.due_date ? `
                <div class="task-meta">
                  ${t.category ? t.category : ''}
                  ${t.due_date ? ' ¬∑ ' + formatDateShort(t.due_date) : ''}
                </div>
              ` : ''}
            </div>
            <div class="task-checkbox" onclick="completeTask('${t.id}', this)">‚úì</div>
          </div>
        `;
      }).join('');
    }

    function renderBacklog(tasks) {
      const grid = document.getElementById('backlogGrid');
      
      // Group by category
      const groups = {};
      tasks.forEach(t => {
        const cat = getCategoryClass(t.category || t.project);
        if (!groups[cat]) groups[cat] = [];
        groups[cat].push(t);
      });

      // Category display names
      const catNames = {
        leadlink: 'LeadLink',
        medivault: 'MediVault', 
        writing: 'Writing',
        errands: 'Errands',
        general: 'General'
      };

      // Order: prioritize categories with tasks
      const order = ['leadlink', 'medivault', 'writing', 'errands', 'general'];
      const sortedCats = order.filter(c => groups[c]?.length);

      if (!sortedCats.length) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: span 2;">
            <div class="empty-icon">üìã</div>
            <div class="empty-text">No backlog tasks</div>
          </div>
        `;
        return;
      }

      grid.innerHTML = sortedCats.map(cat => {
        const tasks = groups[cat];
        const expanded = expandedCategories.has(cat);
        
        return `
          <div class="backlog-box ${expanded ? 'expanded' : ''}" data-category="${cat}">
            <div class="backlog-header" onclick="toggleBacklogBox('${cat}')">
              <span class="backlog-color ${cat}"></span>
              <span class="backlog-name">${catNames[cat]}</span>
              <span class="backlog-count">${tasks.length}</span>
            </div>
            <div class="backlog-tasks">
              ${tasks.map(t => `
                <div class="backlog-task" data-id="${t.id}">
                  <div class="edit-checkbox ${selectedBacklog.has(t.id) ? 'selected' : ''}" 
                       onclick="toggleBacklogSelect('${t.id}', event)">
                    ${selectedBacklog.has(t.id) ? '‚úì' : ''}
                  </div>
                  <span class="backlog-task-text">${esc(t.text)}</span>
                  <div class="activate-btn" onclick="activateTask('${t.id}', event)">+</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleBacklogBox(cat) {
      if (expandedCategories.has(cat)) {
        expandedCategories.delete(cat);
      } else {
        expandedCategories.add(cat);
      }
      const box = document.querySelector(`.backlog-box[data-category="${cat}"]`);
      if (box) box.classList.toggle('expanded');
    }

    // Actions
    async function completeTask(id, el) {
      el.classList.add('checked');
      const result = await api(`/tasks/${id}/complete`, { method: 'POST' });
      if (result?.success) {
        showToast('Done ‚úì');
        setTimeout(() => {
          el.closest('.task-item').style.opacity = '0';
          el.closest('.task-item').style.transform = 'translateX(20px)';
          setTimeout(loadData, 200);
        }, 300);
      }
    }

    async function activateTask(id, event) {
      event.stopPropagation();
      const result = await api(`/tasks/${id}/activate`, { method: 'POST' });
      if (result?.success) {
        showToast('Activated');
        loadData();
      }
    }

    async function incrementGoal(id) {
      const result = await api(`/goals/${id}/increment`, { method: 'POST' });
      if (result?.success) {
        showToast('+1');
        loadData();
      }
    }

    // Edit mode
    function toggleEditMode() {
      editMode = !editMode;
      document.body.classList.toggle('edit-mode', editMode);
      document.getElementById('editBtn').classList.toggle('edit-active', editMode);
      
      if (!editMode) {
        selectedActive.clear();
        selectedBacklog.clear();
        updateSelectedCounts();
      }
    }

    function exitEditMode() {
      editMode = false;
      document.body.classList.remove('edit-mode');
      document.getElementById('editBtn').classList.remove('edit-active');
      selectedActive.clear();
      selectedBacklog.clear();
      loadData(); // Re-render to clear selections
    }

    function toggleActiveSelect(id, event) {
      event.stopPropagation();
      if (selectedActive.has(id)) {
        selectedActive.delete(id);
      } else {
        selectedActive.add(id);
      }
      const checkbox = event.currentTarget;
      checkbox.classList.toggle('selected');
      checkbox.innerHTML = selectedActive.has(id) ? '‚úì' : '';
      updateSelectedCounts();
    }

    function toggleBacklogSelect(id, event) {
      event.stopPropagation();
      if (selectedBacklog.has(id)) {
        selectedBacklog.delete(id);
      } else {
        selectedBacklog.add(id);
      }
      const checkbox = event.currentTarget;
      checkbox.classList.toggle('selected');
      checkbox.innerHTML = selectedBacklog.has(id) ? '‚úì' : '';
      updateSelectedCounts();
    }

    function updateSelectedCounts() {
      document.getElementById('activeSelectedCount').textContent = selectedActive.size;
      document.getElementById('backlogSelectedCount').textContent = selectedBacklog.size;
    }

    async function markSelectedDone() {
      if (!selectedActive.size) return showToast('Select tasks first');
      
      let completed = 0;
      for (const id of selectedActive) {
        const result = await api(`/tasks/${id}/complete`, { method: 'POST' });
        if (result?.success) completed++;
      }
      
      showToast(`${completed} done ‚úì`);
      exitEditMode();
    }

    async function activateSelected() {
      if (!selectedBacklog.size) return showToast('Select tasks first');
      
      let activated = 0;
      for (const id of selectedBacklog) {
        const result = await api(`/tasks/${id}/activate`, { method: 'POST' });
        if (result?.success) activated++;
      }
      
      showToast(`${activated} activated`);
      exitEditMode();
    }

    // Event listeners
    document.getElementById('editBtn').addEventListener('click', toggleEditMode);
    document.getElementById('menuBtn').addEventListener('click', () => {
      document.getElementById('dropdownMenu').classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.dropdown')) {
        document.getElementById('dropdownMenu').classList.remove('show');
      }
    });

    // Helpers
    function formatDateShort(d) {
      if (!d) return '';
      const date = new Date(d);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function esc(s) {
      if (!s) return '';
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    function refreshData() {
      document.getElementById('dropdownMenu').classList.remove('show');
      loadData();
      showToast('Refreshed');
    }

    // Init
    loadData();
  </script>
</body>
</html>