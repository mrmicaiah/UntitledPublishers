<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0c0c0c">
  <title>Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --font-sans: 'Instrument Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'IBM Plex Mono', monospace;
      --bg-base: #0c0c0c;
      --bg-surface: #161616;
      --bg-elevated: #1e1e1e;
      --bg-hover: #262626;
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-default: rgba(255, 255, 255, 0.1);
      --text-primary: #f5f5f5;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-muted: rgba(255, 255, 255, 0.4);
      --color-leadlink: #3b82f6;
      --color-medivault: #10b981;
      --color-writing: #a855f7;
      --color-errands: #f59e0b;
      --color-general: #6b7280;
      --color-eveready: #ec4899;
      --color-proverbs: #8b5cf6;
      --color-frame: #f472b6;
      --color-sprint: #06b6d4;
      --color-success: #22c55e;
      --color-warning: #eab308;
      --color-danger: #ef4444;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }
    html { font-size: 16px; -webkit-font-smoothing: antialiased; }
    body { font-family: var(--font-sans); background: var(--bg-base); color: var(--text-primary); min-height: 100vh; line-height: 1.5; }
    .app { display: flex; flex-direction: column; min-height: 100vh; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--border-subtle); background: var(--bg-surface); }
    .header-left { display: flex; align-items: center; gap: 20px; }
    .sprint-info h1 { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.02em; }
    .sprint-info .dates { font-size: 0.75rem; color: var(--text-muted); }
    .days-chip { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.2); border-radius: 20px; }
    .days-chip .number { font-family: var(--font-mono); font-size: 1.125rem; font-weight: 600; color: var(--color-sprint); }
    .days-chip .label { font-size: 0.6875rem; color: var(--text-muted); }
    .header-right { display: flex; align-items: center; gap: 8px; }
    .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: var(--radius-sm); color: var(--text-secondary); font-size: 1rem; cursor: pointer; transition: all 0.15s ease; }
    .btn-icon:hover { background: var(--bg-hover); color: var(--text-primary); }
    .btn-icon.active { background: var(--color-sprint); border-color: var(--color-sprint); color: white; }
    .main { flex: 1; padding: 24px; display: grid; grid-template-columns: 1fr 2fr; gap: 24px; max-width: 1400px; margin: 0 auto; width: 100%; }
    @media (max-width: 1000px) { .main { grid-template-columns: 1fr; } }
    .section-label { font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .section-label .count { font-family: var(--font-mono); background: var(--bg-elevated); padding: 2px 8px; border-radius: 10px; }
    .panel { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); overflow: hidden; }
    .panel.sprint { border-color: rgba(6, 182, 212, 0.2); }
    .panel-header { padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; }
    .panel-header.sprint-header { background: linear-gradient(135deg, rgba(6, 182, 212, 0.08), transparent); }
    .panel-title { font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .panel-title .icon { font-size: 1rem; }
    .panel-badge { font-family: var(--font-mono); font-size: 0.6875rem; color: var(--color-sprint); background: rgba(6, 182, 212, 0.15); padding: 3px 10px; border-radius: 12px; }
    .task-list { max-height: 400px; overflow-y: auto; }
    .task-row { display: flex; align-items: flex-start; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); transition: background 0.1s; }
    .task-row:last-child { border-bottom: none; }
    .task-row:hover { background: var(--bg-elevated); }
    .task-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 6px; }
    .task-body { flex: 1; min-width: 0; }
    .task-text { font-size: 0.875rem; font-weight: 500; color: var(--text-primary); line-height: 1.4; }
    .task-meta { font-size: 0.6875rem; color: var(--text-muted); margin-top: 2px; }
    .task-meta .overdue { color: var(--color-danger); }
    .task-meta .due { color: var(--color-warning); }
    .task-check { width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--border-default); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; color: transparent; font-size: 0.625rem; transition: all 0.15s; }
    .task-check:hover { border-color: var(--color-success); color: var(--color-success); }
    .task-check.checked { background: var(--color-success); border-color: var(--color-success); color: white; }
    .activate-btn { width: 24px; height: 24px; border-radius: 6px; border: 1px dashed var(--border-default); background: transparent; color: var(--text-muted); font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; }
    .activate-btn:hover { border-style: solid; border-color: var(--color-sprint); color: var(--color-sprint); background: rgba(6, 182, 212, 0.1); }
    .empty-state { padding: 32px 16px; text-align: center; color: var(--text-muted); font-size: 0.8125rem; }
    .right-column { display: flex; flex-direction: column; gap: 24px; }
    .backlog-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
    .category-box { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); overflow: hidden; }
    .category-header { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--bg-elevated); border-bottom: 1px solid var(--border-subtle); }
    .category-dot { width: 8px; height: 8px; border-radius: 2px; }
    .category-name { flex: 1; font-size: 0.75rem; font-weight: 600; }
    .category-count { font-family: var(--font-mono); font-size: 0.625rem; color: var(--text-muted); background: var(--bg-base); padding: 2px 6px; border-radius: 8px; }
    .category-tasks { max-height: 200px; overflow-y: auto; }
    .cat-task { display: flex; align-items: flex-start; gap: 10px; padding: 10px 14px; border-bottom: 1px solid var(--border-subtle); transition: background 0.1s; }
    .cat-task:last-child { border-bottom: none; }
    .cat-task:hover { background: var(--bg-elevated); }
    .cat-task-text { flex: 1; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.35; }
    .cat-task-due { font-size: 0.625rem; color: var(--text-muted); margin-top: 2px; }
    .cat-task-due.warning { color: var(--color-warning); }
    .edit-check { width: 20px; height: 20px; border-radius: 5px; border: 2px solid var(--border-default); background: transparent; display: none; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; color: transparent; font-size: 0.5rem; transition: all 0.15s; }
    .edit-mode .edit-check { display: flex; }
    .edit-mode .task-check, .edit-mode .activate-btn { display: none; }
    .edit-check.selected { background: var(--color-sprint); border-color: var(--color-sprint); color: white; }
    .edit-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-surface); border-top: 1px solid var(--border-default); padding: 14px 24px; display: none; justify-content: center; gap: 12px; z-index: 100; }
    .edit-mode .edit-bar { display: flex; }
    .edit-btn { padding: 10px 24px; border-radius: var(--radius-sm); border: none; font-family: var(--font-sans); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .edit-btn.cancel { background: var(--bg-elevated); color: var(--text-secondary); border: 1px solid var(--border-default); }
    .edit-btn.done { background: var(--color-success); color: white; }
    .edit-btn.activate { background: var(--color-sprint); color: white; }
    .dropdown { position: relative; }
    .dropdown-menu { position: absolute; top: calc(100% + 6px); right: 0; min-width: 140px; background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: var(--radius-sm); padding: 6px; opacity: 0; visibility: hidden; transform: translateY(-6px); transition: all 0.15s; z-index: 200; }
    .dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .dropdown-item { display: block; width: 100%; padding: 8px 12px; font-size: 0.8125rem; font-family: var(--font-sans); color: var(--text-secondary); background: none; border: none; border-radius: 4px; text-align: left; cursor: pointer; transition: all 0.1s; }
    .dropdown-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(16px); background: var(--bg-elevated); border: 1px solid var(--border-default); padding: 12px 24px; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 500; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 1000; }
    .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .edit-mode .toast { bottom: 80px; }
    .dot-leadlink { background: var(--color-leadlink); }
    .dot-medivault { background: var(--color-medivault); }
    .dot-writing { background: var(--color-writing); }
    .dot-errands { background: var(--color-errands); }
    .dot-general { background: var(--color-general); }
    .dot-eveready { background: var(--color-eveready); }
    .dot-proverbs { background: var(--color-proverbs); }
    .dot-frame { background: var(--color-frame); }
    @media (max-width: 600px) {
      .header { padding: 12px 16px; }
      .main { padding: 16px; gap: 16px; }
      .backlog-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="header">
      <div class="header-left">
        <div class="sprint-info">
          <h1 id="sprintTitle">Loading...</h1>
          <div class="dates" id="sprintDates"></div>
        </div>
        <div class="days-chip">
          <span class="number" id="daysLeft">‚Äì</span>
          <span class="label">days left</span>
        </div>
      </div>
      <div class="header-right">
        <button class="btn-icon" id="editBtn" title="Edit">‚úèÔ∏è</button>
        <button class="btn-icon" id="refreshBtn" title="Refresh">‚Üª</button>
        <div class="dropdown">
          <button class="btn-icon" id="menuBtn">‚ò∞</button>
          <div class="dropdown-menu" id="dropdownMenu">
            <button class="dropdown-item" onclick="location.href='guide.html'">üìñ Help</button>
            <button class="dropdown-item" onclick="logout()">üö™ Sign Out</button>
          </div>
        </div>
      </div>
    </header>
    <main class="main">
      <div class="left-column">
        <div class="section-label">Active Now <span class="count" id="activeCount">0</span></div>
        <div class="panel">
          <div class="task-list" id="activeList"></div>
        </div>
      </div>
      <div class="right-column">
        <div>
          <div class="section-label">üéØ Sprint <span class="count" id="sprintCount">0</span></div>
          <div class="panel sprint">
            <div class="task-list" id="sprintList"></div>
          </div>
        </div>
        <div>
          <div class="section-label">Backlog</div>
          <div class="backlog-grid" id="backlogGrid"></div>
        </div>
      </div>
    </main>
    <div class="edit-bar">
      <button class="edit-btn cancel" onclick="exitEditMode()">Cancel</button>
      <button class="edit-btn done" onclick="markSelectedDone()">‚úì Done (<span id="activeSelCount">0</span>)</button>
      <button class="edit-btn activate" onclick="activateSelected()">+ Activate (<span id="otherSelCount">0</span>)</button>
    </div>
  </div>
  <div class="toast" id="toast"></div>
  <script>
    (function() {
      if (localStorage.getItem('authenticated') !== 'true' || !localStorage.getItem('apiUrl')) {
        location.href = 'index.html';
      }
    })();
    const API = localStorage.getItem('apiUrl');
    const state = { editMode: false, selActive: new Set(), selSprint: new Set(), selBacklog: new Set() };
    const COLORS = { leadlink: 'leadlink', 'lead link': 'leadlink', medivault: 'medivault', tech: 'medivault', writing: 'writing', 'the frame': 'frame', proverbs: 'proverbs', 'proverbs library': 'proverbs', errands: 'errands', eveready: 'eveready' };
    function getColor(cat) { if (!cat) return 'general'; const l = cat.toLowerCase(); for (const [k, v] of Object.entries(COLORS)) if (l.includes(k)) return v; return 'general'; }
    async function api(path, opts = {}) {
      try { const r = await fetch(API + path, { ...opts, headers: { 'Content-Type': 'application/json' } }); if (!r.ok) throw new Error(); return await r.json(); }
      catch { toast('Request failed'); return null; }
    }
    async function load() {
      const d = await api('/morning');
      if (!d) return;
      const plan = d.plan;
      if (plan) {
        document.getElementById('sprintTitle').textContent = plan.title || 'Sprint';
        document.getElementById('sprintDates').textContent = fmtDate(plan.startDate) + ' ‚Üí ' + fmtDate(plan.endDate);
        document.getElementById('daysLeft').textContent = plan.workDaysRemaining ?? '‚Äì';
      } else {
        document.getElementById('sprintTitle').textContent = 'No Active Plan';
        document.getElementById('sprintDates').textContent = '';
        document.getElementById('daysLeft').textContent = '‚Äì';
      }
      renderActive(d.activeTasks || []);
      renderSprint(d.sprintTasks || []);
      renderBacklog(d.backlogByCategory || {});
    }
    function renderActive(tasks) {
      document.getElementById('activeCount').textContent = tasks.length;
      const el = document.getElementById('activeList');
      if (!tasks.length) { el.innerHTML = '<div class="empty-state">All clear! Activate tasks from Sprint or Backlog.</div>'; return; }
      el.innerHTML = tasks.map(t => {
        const c = getColor(t.category || t.project), sel = state.selActive.has(t.id);
        let meta = t.category || '';
        if (t.due_date) meta += (meta ? ' ¬∑ ' : '') + '<span class="' + (overdue(t.due_date) ? 'overdue' : 'due') + '">' + fmtDate(t.due_date) + '</span>';
        return '<div class="task-row" data-id="' + t.id + '"><div class="edit-check ' + (sel ? 'selected' : '') + '" onclick="toggleSel(\'active\',\'' + t.id + '\',this)">‚úì</div><div class="task-dot dot-' + c + '"></div><div class="task-body"><div class="task-text">' + esc(t.text) + '</div>' + (meta ? '<div class="task-meta">' + meta + '</div>' : '') + '</div><div class="task-check" onclick="complete(\'' + t.id + '\',this)">‚úì</div></div>';
      }).join('');
    }
    function renderSprint(tasks) {
      document.getElementById('sprintCount').textContent = tasks.length;
      const el = document.getElementById('sprintList');
      if (!tasks.length) { el.innerHTML = '<div class="empty-state">No sprint tasks yet.</div>'; return; }
      el.innerHTML = tasks.map(t => {
        const c = getColor(t.category || t.project), sel = state.selSprint.has(t.id);
        let meta = t.category || '';
        if (t.goal_description) meta += (meta ? ' ‚Üí ' : '') + t.goal_description;
        if (t.due_date) meta += (meta ? ' ¬∑ ' : '') + '<span class="' + (overdue(t.due_date) ? 'overdue' : 'due') + '">' + fmtDate(t.due_date) + '</span>';
        return '<div class="task-row" data-id="' + t.id + '"><div class="edit-check ' + (sel ? 'selected' : '') + '" onclick="toggleSel(\'sprint\',\'' + t.id + '\',this)">‚úì</div><div class="task-dot dot-' + c + '"></div><div class="task-body"><div class="task-text">' + esc(t.text) + '</div>' + (meta ? '<div class="task-meta">' + meta + '</div>' : '') + '</div><button class="activate-btn" onclick="activate(\'' + t.id + '\')">+</button></div>';
      }).join('');
    }
    function renderBacklog(byCategory) {
      const el = document.getElementById('backlogGrid');
      const cats = Object.keys(byCategory);
      if (!cats.length) { el.innerHTML = '<div class="empty-state">No backlog tasks.</div>'; return; }
      el.innerHTML = cats.map(cat => {
        const tasks = byCategory[cat], c = getColor(cat);
        return '<div class="category-box"><div class="category-header"><div class="category-dot dot-' + c + '"></div><div class="category-name">' + esc(cat) + '</div><div class="category-count">' + tasks.length + '</div></div><div class="category-tasks">' + tasks.map(t => {
          const sel = state.selBacklog.has(t.id);
          return '<div class="cat-task" data-id="' + t.id + '"><div class="edit-check ' + (sel ? 'selected' : '') + '" onclick="toggleSel(\'backlog\',\'' + t.id + '\',this)">‚úì</div><div class="task-body"><div class="cat-task-text">' + esc(t.text) + '</div>' + (t.due_date ? '<div class="cat-task-due ' + (overdue(t.due_date) ? 'warning' : '') + '">' + fmtDate(t.due_date) + '</div>' : '') + '</div><button class="activate-btn" onclick="activate(\'' + t.id + '\')">+</button></div>';
        }).join('') + '</div></div>';
      }).join('');
    }
    async function complete(id, el) { el.classList.add('checked'); const r = await api('/tasks/' + id + '/complete', { method: 'POST' }); if (r?.success) { toast('Done ‚úì'); setTimeout(load, 200); } else el.classList.remove('checked'); }
    async function activate(id) { const r = await api('/tasks/' + id + '/activate', { method: 'POST' }); if (r?.success) { toast('Activated'); load(); } }
    function toggleSel(type, id, el) {
      const set = type === 'active' ? state.selActive : type === 'sprint' ? state.selSprint : state.selBacklog;
      set.has(id) ? set.delete(id) : set.add(id);
      el.classList.toggle('selected');
      updateCounts();
    }
    function updateCounts() {
      document.getElementById('activeSelCount').textContent = state.selActive.size;
      document.getElementById('otherSelCount').textContent = state.selSprint.size + state.selBacklog.size;
    }
    function toggleEdit() {
      state.editMode = !state.editMode;
      document.getElementById('app').classList.toggle('edit-mode', state.editMode);
      document.getElementById('editBtn').classList.toggle('active', state.editMode);
      if (!state.editMode) { state.selActive.clear(); state.selSprint.clear(); state.selBacklog.clear(); updateCounts(); }
    }
    function exitEditMode() { state.editMode = false; state.selActive.clear(); state.selSprint.clear(); state.selBacklog.clear(); document.getElementById('app').classList.remove('edit-mode'); document.getElementById('editBtn').classList.remove('active'); load(); }
    async function markSelectedDone() {
      if (!state.selActive.size) { toast('Select active tasks'); return; }
      let n = 0; for (const id of state.selActive) { const r = await api('/tasks/' + id + '/complete', { method: 'POST' }); if (r?.success) n++; }
      toast(n + ' completed'); exitEditMode();
    }
    async function activateSelected() {
      const ids = [...state.selSprint, ...state.selBacklog];
      if (!ids.length) { toast('Select tasks'); return; }
      let n = 0; for (const id of ids) { const r = await api('/tasks/' + id + '/activate', { method: 'POST' }); if (r?.success) n++; }
      toast(n + ' activated'); exitEditMode();
    }
    function toast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
    function logout() { localStorage.clear(); location.href = 'index.html'; }
    function fmtDate(s) { if (!s) return ''; return new Date(s).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
    function overdue(s) { if (!s) return false; const d = new Date(s), t = new Date(); t.setHours(0,0,0,0); return d < t; }
    function esc(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }
    document.getElementById('editBtn').onclick = toggleEdit;
    document.getElementById('refreshBtn').onclick = () => { load(); toast('Refreshed'); };
    document.getElementById('menuBtn').onclick = e => { e.stopPropagation(); document.getElementById('dropdownMenu').classList.toggle('show'); };
    document.onclick = e => { if (!e.target.closest('.dropdown')) document.getElementById('dropdownMenu').classList.remove('show'); };
    load();
  </script>
</body>
</html>