<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#ffffff">
  <title>Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --bg: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --text: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --accent: #2563eb;
      --accent-light: #eff6ff;
      --success: #10b981;
      --success-light: #ecfdf5;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
      --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
      --radius: 10px;
      --radius-sm: 6px;
    }
    html { font-size: 15px; }
    body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; line-height: 1.5; }
    .app { min-height: 100vh; }
    
    /* Header */
    .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo { font-size: 1.125rem; font-weight: 700; color: var(--text); }
    .logo span { color: var(--accent); }
    .sprint-pill { display: flex; align-items: center; gap: 10px; background: var(--accent-light); padding: 6px 12px 6px 10px; border-radius: 20px; font-size: 0.8125rem; color: var(--accent); font-weight: 500; }
    .sprint-pill .days { font-weight: 700; font-size: 1rem; }
    .header-actions { display: flex; gap: 6px; }
    .btn-icon { width: 36px; height: 36px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--surface); color: var(--text-secondary); font-size: 0.9375rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .btn-icon:hover { background: var(--bg); border-color: #cbd5e1; }
    .btn-icon.active { background: var(--accent); border-color: var(--accent); color: white; }

    /* Main Layout */
    .main { max-width: 1300px; margin: 0 auto; padding: 24px; display: grid; grid-template-columns: 340px 1fr; gap: 24px; }
    @media (max-width: 900px) { .main { grid-template-columns: 1fr; } }

    /* Section Headers */
    .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .section-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); }
    .section-count { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); background: var(--bg); padding: 2px 8px; border-radius: 10px; }

    /* Cards */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-sm); overflow: hidden; }
    .card.sprint { border-color: #bfdbfe; background: linear-gradient(to bottom, #fafcff, var(--surface)); }

    /* Task Rows */
    .task-list { max-height: 420px; overflow-y: auto; }
    .task-row { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-bottom: 1px solid var(--border-light); transition: background 0.1s; }
    .task-row:last-child { border-bottom: none; }
    .task-row:hover { background: #fafbfc; }
    .task-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .task-content { flex: 1; min-width: 0; }
    .task-text { font-size: 0.9375rem; font-weight: 500; color: var(--text); line-height: 1.35; }
    .task-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 1px; }
    .task-meta .overdue { color: var(--danger); font-weight: 500; }
    .task-meta .due { color: var(--warning); }
    .task-actions { display: flex; gap: 6px; flex-shrink: 0; }
    
    /* Action Buttons */
    .btn-done { padding: 6px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--surface); color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; font-family: var(--font); cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 4px; }
    .btn-done:hover { background: var(--success-light); border-color: var(--success); color: var(--success); }
    .btn-done.checked { background: var(--success); border-color: var(--success); color: white; }
    .btn-activate { padding: 6px 10px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--surface); color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; font-family: var(--font); cursor: pointer; transition: all 0.15s; }
    .btn-activate:hover { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }

    /* Empty State */
    .empty { padding: 40px 20px; text-align: center; color: var(--text-muted); font-size: 0.875rem; }

    /* Right Column */
    .right-col { display: flex; flex-direction: column; gap: 24px; }

    /* Backlog Grid */
    .backlog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .category-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-sm); overflow: hidden; }
    .category-header { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg); border-bottom: 1px solid var(--border-light); }
    .category-dot { width: 8px; height: 8px; border-radius: 2px; }
    .category-name { flex: 1; font-size: 0.8125rem; font-weight: 600; color: var(--text); }
    .category-count { font-size: 0.6875rem; font-weight: 600; color: var(--text-muted); }
    .category-tasks { max-height: 180px; overflow-y: auto; }
    .cat-row { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-bottom: 1px solid var(--border-light); transition: background 0.1s; }
    .cat-row:last-child { border-bottom: none; }
    .cat-row:hover { background: #fafbfc; }
    .cat-text { flex: 1; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.35; }
    .cat-due { font-size: 0.6875rem; color: var(--text-muted); }
    .cat-due.warning { color: var(--warning); }

    /* Edit Mode */
    .edit-check { width: 20px; height: 20px; border-radius: 4px; border: 2px solid var(--border); background: var(--surface); display: none; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; color: transparent; font-size: 0.625rem; transition: all 0.12s; }
    .edit-mode .edit-check { display: flex; }
    .edit-mode .task-actions { display: none; }
    .edit-check:hover { border-color: var(--accent); }
    .edit-check.selected { background: var(--accent); border-color: var(--accent); color: white; }
    .edit-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); padding: 12px 24px; display: none; justify-content: center; gap: 10px; z-index: 100; box-shadow: 0 -4px 12px rgba(0,0,0,0.05); }
    .edit-mode .edit-bar { display: flex; }
    .edit-btn { padding: 10px 20px; border-radius: var(--radius-sm); border: none; font-family: var(--font); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .edit-btn.cancel { background: var(--bg); color: var(--text-secondary); border: 1px solid var(--border); }
    .edit-btn.done { background: var(--success); color: white; }
    .edit-btn.activate { background: var(--accent); color: white; }
    .edit-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }

    /* Dropdown */
    .dropdown { position: relative; }
    .dropdown-menu { position: absolute; top: calc(100% + 4px); right: 0; min-width: 140px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 4px; box-shadow: var(--shadow-md); opacity: 0; visibility: hidden; transform: translateY(-4px); transition: all 0.15s; z-index: 200; }
    .dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .dropdown-item { display: block; width: 100%; padding: 8px 10px; font-size: 0.8125rem; font-family: var(--font); color: var(--text-secondary); background: none; border: none; border-radius: 4px; text-align: left; cursor: pointer; }
    .dropdown-item:hover { background: var(--bg); color: var(--text); }

    /* Toast */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(10px); background: var(--text); color: white; padding: 10px 20px; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 500; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 1000; }
    .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .edit-mode .toast { bottom: 72px; }

    /* Colors */
    .dot-leadlink { background: #3b82f6; }
    .dot-medivault { background: #10b981; }
    .dot-writing { background: #8b5cf6; }
    .dot-errands { background: #f59e0b; }
    .dot-general { background: #64748b; }
    .dot-eveready { background: #ec4899; }
    .dot-proverbs { background: #a855f7; }
    .dot-frame { background: #f472b6; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="header">
      <div class="header-left">
        <div class="logo">Untitled<span>.</span></div>
        <div class="sprint-pill">
          <span id="sprintTitle">Loading...</span>
          <span class="days" id="daysLeft">‚Äì</span> days
        </div>
      </div>
      <div class="header-actions">
        <button class="btn-icon" id="editBtn" title="Edit">‚úèÔ∏è</button>
        <button class="btn-icon" id="refreshBtn" title="Refresh">‚Üª</button>
        <div class="dropdown">
          <button class="btn-icon" id="menuBtn">‚ò∞</button>
          <div class="dropdown-menu" id="dropdownMenu">
            <button class="dropdown-item" onclick="location.href='guide.html'">üìñ Help</button>
            <button class="dropdown-item" onclick="logout()">üö™ Sign Out</button>
          </div>
        </div>
      </div>
    </header>
    <main class="main">
      <div class="left-col">
        <div class="section-header">
          <span class="section-title">Active</span>
          <span class="section-count" id="activeCount">0</span>
        </div>
        <div class="card">
          <div class="task-list" id="activeList"></div>
        </div>
      </div>
      <div class="right-col">
        <div>
          <div class="section-header">
            <span class="section-title">üéØ Sprint</span>
            <span class="section-count" id="sprintCount">0</span>
          </div>
          <div class="card sprint">
            <div class="task-list" id="sprintList"></div>
          </div>
        </div>
        <div>
          <div class="section-header">
            <span class="section-title">Backlog</span>
          </div>
          <div class="backlog-grid" id="backlogGrid"></div>
        </div>
      </div>
    </main>
    <div class="edit-bar">
      <button class="edit-btn cancel" onclick="exitEdit()">Cancel</button>
      <button class="edit-btn done" onclick="doneSelected()">‚úì Complete (<span id="selActive">0</span>)</button>
      <button class="edit-btn activate" onclick="activateSelected()">+ Activate (<span id="selOther">0</span>)</button>
    </div>
  </div>
  <div class="toast" id="toast"></div>
  <script>
    (function(){ if(localStorage.getItem('authenticated')!=='true'||!localStorage.getItem('apiUrl')) location.href='index.html'; })();
    const API=localStorage.getItem('apiUrl');
    const S={edit:false,active:new Set(),sprint:new Set(),backlog:new Set()};
    const C={leadlink:'leadlink','lead link':'leadlink',medivault:'medivault',tech:'medivault',writing:'writing','the frame':'frame',proverbs:'proverbs','proverbs library':'proverbs',errands:'errands',eveready:'eveready'};
    const color=c=>{if(!c)return'general';const l=c.toLowerCase();for(const[k,v]of Object.entries(C))if(l.includes(k))return v;return'general';};
    const api=async(p,o={})=>{try{const r=await fetch(API+p,{...o,headers:{'Content-Type':'application/json'}});if(!r.ok)throw 0;return await r.json();}catch{toast('Request failed');return null;}};
    const load=async()=>{
      const d=await api('/morning');if(!d)return;
      const p=d.plan;
      document.getElementById('sprintTitle').textContent=p?.title||'No Plan';
      document.getElementById('daysLeft').textContent=p?.workDaysRemaining??'‚Äì';
      renderActive(d.activeTasks||[]);
      renderSprint(d.sprintTasks||[]);
      renderBacklog(d.backlogByCategory||{});
    };
    const renderActive=tasks=>{
      document.getElementById('activeCount').textContent=tasks.length;
      const el=document.getElementById('activeList');
      if(!tasks.length){el.innerHTML='<div class="empty">All clear! Activate tasks from Sprint or Backlog.</div>';return;}
      el.innerHTML=tasks.map(t=>{
        const c=color(t.category||t.project);
        let m=t.category||'';
        if(t.due_date)m+=(m?' ¬∑ ':'')+'<span class="'+(over(t.due_date)?'overdue':'due')+'">'+fmt(t.due_date)+'</span>';
        return'<div class="task-row"><div class="edit-check'+(S.active.has(t.id)?' selected':'')+'" onclick="tog(\'active\',\''+t.id+'\',this)">‚úì</div><div class="task-dot dot-'+c+'"></div><div class="task-content"><div class="task-text">'+esc(t.text)+'</div>'+(m?'<div class="task-meta">'+m+'</div>':'')+'</div><div class="task-actions"><button class="btn-done" onclick="done(\''+t.id+'\',this)">‚úì Done</button></div></div>';
      }).join('');
    };
    const renderSprint=tasks=>{
      document.getElementById('sprintCount').textContent=tasks.length;
      const el=document.getElementById('sprintList');
      if(!tasks.length){el.innerHTML='<div class="empty">No sprint tasks. Link tasks to plan goals.</div>';return;}
      el.innerHTML=tasks.map(t=>{
        const c=color(t.category||t.project);
        let m=t.category||'';
        if(t.goal_description)m+=(m?' ‚Üí ':'')+t.goal_description;
        if(t.due_date)m+=(m?' ¬∑ ':'')+'<span class="'+(over(t.due_date)?'overdue':'due')+'">'+fmt(t.due_date)+'</span>';
        return'<div class="task-row"><div class="edit-check'+(S.sprint.has(t.id)?' selected':'')+'" onclick="tog(\'sprint\',\''+t.id+'\',this)">‚úì</div><div class="task-dot dot-'+c+'"></div><div class="task-content"><div class="task-text">'+esc(t.text)+'</div>'+(m?'<div class="task-meta">'+m+'</div>':'')+'</div><div class="task-actions"><button class="btn-done" onclick="done(\''+t.id+'\',this)">‚úì Done</button><button class="btn-activate" onclick="activate(\''+t.id+'\')">+ Active</button></div></div>';
      }).join('');
    };
    const renderBacklog=by=>{
      const el=document.getElementById('backlogGrid');
      const cats=Object.keys(by);
      if(!cats.length){el.innerHTML='<div class="empty">No backlog tasks.</div>';return;}
      el.innerHTML=cats.map(cat=>{
        const tasks=by[cat],c=color(cat);
        return'<div class="category-card"><div class="category-header"><div class="category-dot dot-'+c+'"></div><div class="category-name">'+esc(cat)+'</div><div class="category-count">'+tasks.length+'</div></div><div class="category-tasks">'+tasks.map(t=>'<div class="cat-row"><div class="edit-check'+(S.backlog.has(t.id)?' selected':'')+'" onclick="tog(\'backlog\',\''+t.id+'\',this)">‚úì</div><div class="task-content"><div class="cat-text">'+esc(t.text)+'</div>'+(t.due_date?'<div class="cat-due'+(over(t.due_date)?' warning':'')+'">'+fmt(t.due_date)+'</div>':'')+'</div><div class="task-actions"><button class="btn-activate" onclick="activate(\''+t.id+'\')">+ Active</button></div></div>').join('')+'</div></div>';
      }).join('');
    };
    const done=async(id,el)=>{el.classList.add('checked');el.textContent='‚úì';const r=await api('/tasks/'+id+'/complete',{method:'POST'});if(r?.success){toast('Done ‚úì');setTimeout(load,200);}else{el.classList.remove('checked');el.textContent='‚úì Done';}};
    const activate=async id=>{const r=await api('/tasks/'+id+'/activate',{method:'POST'});if(r?.success){toast('Activated');load();}};
    const tog=(type,id,el)=>{const s=type==='active'?S.active:type==='sprint'?S.sprint:S.backlog;s.has(id)?s.delete(id):s.add(id);el.classList.toggle('selected');updCounts();};
    const updCounts=()=>{document.getElementById('selActive').textContent=S.active.size;document.getElementById('selOther').textContent=S.sprint.size+S.backlog.size;};
    const toggleEdit=()=>{S.edit=!S.edit;document.getElementById('app').classList.toggle('edit-mode',S.edit);document.getElementById('editBtn').classList.toggle('active',S.edit);if(!S.edit){S.active.clear();S.sprint.clear();S.backlog.clear();updCounts();}};
    const exitEdit=()=>{S.edit=false;S.active.clear();S.sprint.clear();S.backlog.clear();document.getElementById('app').classList.remove('edit-mode');document.getElementById('editBtn').classList.remove('active');load();};
    const doneSelected=async()=>{if(!S.active.size){toast('Select active tasks');return;}let n=0;for(const id of S.active){const r=await api('/tasks/'+id+'/complete',{method:'POST'});if(r?.success)n++;}toast(n+' completed');exitEdit();};
    const activateSelected=async()=>{const ids=[...S.sprint,...S.backlog];if(!ids.length){toast('Select tasks');return;}let n=0;for(const id of ids){const r=await api('/tasks/'+id+'/activate',{method:'POST'});if(r?.success)n++;}toast(n+' activated');exitEdit();};
    const toast=m=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);};
    const logout=()=>{localStorage.clear();location.href='index.html';};
    const fmt=s=>s?new Date(s).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';
    const over=s=>{if(!s)return false;const d=new Date(s),t=new Date();t.setHours(0,0,0,0);return d<t;};
    const esc=s=>s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):'';
    document.getElementById('editBtn').onclick=toggleEdit;
    document.getElementById('refreshBtn').onclick=()=>{load();toast('Refreshed');};
    document.getElementById('menuBtn').onclick=e=>{e.stopPropagation();document.getElementById('dropdownMenu').classList.toggle('show');};
    document.onclick=e=>{if(!e.target.closest('.dropdown'))document.getElementById('dropdownMenu').classList.remove('show');};
    load();
  </script>
</body>
</html>