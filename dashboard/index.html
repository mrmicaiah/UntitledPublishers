<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a1512">
  <title>Productivity Engine</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-dark: #1a1512; --bg-rust: #2a1f1a; --bg-metal: #252019; --bg-panel: #1f1915;
      --rust-dark: #8b4513; --rust-medium: #a0522d; --rust-light: #cd853f;
      --brass: #b8860b; --brass-light: #d4a537; --copper: #b87333; --copper-glow: #da8a47;
      --steel: #71797E; --text-primary: #e8dcc8; --text-secondary: #a89880; --text-muted: #6d5d4d;
      --accent-green: #4a7c59; --accent-green-glow: #5d9e6e; --accent-red: #8b3a3a; --accent-red-glow: #a94442;
      --accent-yellow: #b8860b; --rivet: #3d3429;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary); min-height: 100vh; padding: 12px;
    }
    
    /* Login */
    .login-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-dark);
      background-image: radial-gradient(ellipse at 30% 30%, rgba(139, 69, 19, 0.15) 0%, transparent 50%);
      display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;
    }
    .login-screen.hidden { display: none; }
    .login-logo { font-size: 64px; margin-bottom: 20px; animation: rotate-slow 20s linear infinite; }
    .login-title { font-size: 24px; font-weight: 700; color: var(--brass-light); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 3px; }
    .login-subtitle { font-size: 12px; color: var(--text-muted); margin-bottom: 40px; font-family: 'Courier Prime', monospace; }
    .login-box { background: var(--bg-panel); border: 1px solid var(--rust-dark); border-radius: 8px; padding: 32px; width: 90%; max-width: 320px; }
    .login-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 12px; display: block; text-align: center; }
    .pin-input-container { display: flex; gap: 12px; justify-content: center; margin-bottom: 24px; }
    .pin-digit { width: 50px; height: 60px; background: var(--bg-dark); border: 2px solid var(--rust-medium); border-radius: 6px; font-size: 24px; font-family: 'Courier Prime', monospace; color: var(--brass-light); text-align: center; }
    .pin-digit:focus { outline: none; border-color: var(--brass); }
    .pin-digit.error { border-color: var(--accent-red); animation: shake 0.3s ease; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .login-btn { width: 100%; padding: 14px; background: var(--rust-medium); border: 1px solid var(--rust-dark); border-radius: 4px; color: var(--text-primary); font-size: 14px; font-weight: 600; text-transform: uppercase; cursor: pointer; }
    .login-btn:hover { background: var(--rust-light); }
    .login-error { color: var(--accent-red-glow); font-size: 12px; text-align: center; margin-top: 16px; opacity: 0; }
    .login-error.show { opacity: 1; }
    
    .main-app { display: none; } .main-app.visible { display: block; }
    
    /* Header Bar */
    .header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-rust); border-radius: 6px; margin-bottom: 12px; border: 1px solid var(--rust-dark); }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-logo { font-size: 24px; }
    .header-title { font-size: 16px; font-weight: 600; color: var(--brass-light); }
    .header-date { font-size: 11px; color: var(--text-muted); font-family: 'Courier Prime', monospace; }
    .header-actions { display: flex; gap: 8px; }
    .header-btn { padding: 6px 12px; background: var(--bg-metal); border: 1px solid var(--rust-dark); border-radius: 4px; color: var(--text-secondary); font-size: 11px; cursor: pointer; }
    .header-btn:hover { border-color: var(--brass); color: var(--text-primary); }

    /* Sprint Banner */
    .sprint-banner { background: linear-gradient(135deg, var(--bg-panel) 0%, var(--bg-metal) 100%); border: 1px solid var(--brass); border-radius: 6px; padding: 16px; margin-bottom: 12px; }
    .sprint-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .sprint-name { font-size: 15px; font-weight: 600; color: var(--brass-light); }
    .sprint-days { font-size: 12px; color: var(--text-secondary); font-family: 'Courier Prime', monospace; }
    .sprint-days.urgent { color: var(--accent-red-glow); }
    .sprint-days.warning { color: var(--accent-yellow); }
    .progress-bar { height: 6px; background: var(--bg-dark); border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
    .progress-fill { height: 100%; background: var(--accent-green-glow); border-radius: 3px; }
    .progress-fill.warning { background: var(--accent-yellow); }
    .progress-fill.danger { background: var(--accent-red-glow); }
    .sprint-stats { font-size: 11px; color: var(--text-muted); font-family: 'Courier Prime', monospace; margin-bottom: 10px; }
    .objectives-row { display: flex; flex-wrap: wrap; gap: 8px; }
    .objective-chip { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--bg-dark); border-radius: 4px; font-size: 11px; border: 1px solid var(--rivet); }
    .objective-chip .icon { font-size: 12px; }
    .objective-chip .count { color: var(--brass); font-family: 'Courier Prime', monospace; }

    /* Section */
    .section { margin-bottom: 16px; }
    .section-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding: 8px 12px; background: var(--bg-rust); border-radius: 4px; }
    .section-title { font-size: 13px; font-weight: 600; color: var(--brass-light); text-transform: uppercase; letter-spacing: 1px; }
    .section-count { font-size: 11px; color: var(--brass); font-family: 'Courier Prime', monospace; background: var(--bg-dark); padding: 2px 8px; border-radius: 10px; }
    .section-header.active { background: linear-gradient(90deg, var(--accent-green) 0%, var(--bg-rust) 100%); }
    .section-header.overdue { background: linear-gradient(90deg, var(--accent-red) 0%, var(--bg-rust) 100%); }
    .section-header.sprint { background: linear-gradient(90deg, var(--copper) 0%, var(--bg-rust) 100%); }

    /* Task Grid */
    .task-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; }
    
    /* Task Card */
    .task-card { background: var(--bg-panel); border: 1px solid var(--rivet); border-radius: 6px; padding: 12px; display: flex; flex-direction: column; min-height: 100px; transition: all 0.2s; position: relative; }
    .task-card:hover { border-color: var(--rust-medium); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .task-card.active { border-color: var(--accent-green); background: linear-gradient(135deg, rgba(74, 124, 89, 0.15) 0%, var(--bg-panel) 100%); }
    .task-card.overdue { border-left: 3px solid var(--accent-red); }
    .task-card.in-sprint { border-left: 3px solid var(--copper); }
    
    .task-text { font-size: 13px; color: var(--text-primary); line-height: 1.5; flex: 1; margin-bottom: 10px; }
    .task-meta { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px; }
    .task-tag { font-size: 9px; padding: 2px 6px; border-radius: 2px; background: var(--bg-dark); color: var(--text-muted); border: 1px solid var(--rivet); text-transform: uppercase; letter-spacing: 0.5px; }
    .task-tag.due { color: var(--accent-yellow); border-color: var(--accent-yellow); }
    .task-tag.due.overdue { color: var(--accent-red-glow); border-color: var(--accent-red); }
    .task-tag.objective { color: var(--copper-glow); border-color: var(--copper); }
    .task-tag.category { color: var(--text-secondary); }
    
    .task-actions { display: flex; gap: 6px; margin-top: auto; }
    .task-btn { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid var(--rivet); background: var(--bg-dark); color: var(--text-muted); font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; transition: all 0.15s; }
    .task-btn:hover { border-color: var(--brass); color: var(--text-primary); }
    .task-btn.complete { border-color: var(--accent-green); color: var(--accent-green-glow); }
    .task-btn.complete:hover { background: var(--accent-green); color: white; }
    .task-btn.activate { border-color: var(--brass); color: var(--brass); }
    .task-btn.activate:hover { background: var(--brass); color: var(--bg-dark); }
    .task-btn.deactivate { border-color: var(--rust-medium); color: var(--rust-light); }
    .task-btn.deactivate:hover { background: var(--rust-medium); color: white; }
    .task-btn.completing { background: var(--accent-green); color: white; pointer-events: none; }

    /* Category Label */
    .category-label { grid-column: 1 / -1; font-size: 12px; font-weight: 600; color: var(--rust-light); text-transform: uppercase; letter-spacing: 1px; padding: 8px 0 4px; border-bottom: 1px solid var(--rivet); margin-top: 8px; display: flex; align-items: center; gap: 8px; }
    .category-label:first-child { margin-top: 0; }
    .category-count { font-size: 10px; color: var(--brass); background: var(--bg-dark); padding: 2px 6px; border-radius: 8px; font-family: 'Courier Prime', monospace; }

    /* Empty */
    .empty-state { grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--text-muted); font-size: 13px; background: var(--bg-metal); border-radius: 6px; border: 1px dashed var(--rivet); }

    /* Toast */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bg-panel); border: 1px solid var(--brass); padding: 12px 24px; border-radius: 4px; font-size: 13px; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
    .toast.show { opacity: 1; }
    .toast.success { border-color: var(--accent-green); }

    /* Loading */
    .loading { grid-column: 1 / -1; display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-secondary); }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--rivet); border-top-color: var(--brass); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 600px) {
      .task-grid { grid-template-columns: 1fr; }
      body { padding: 8px; }
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="login-screen" id="loginScreen">
    <div class="login-logo">‚öôÔ∏è</div>
    <div class="login-title">Productivity Engine</div>
    <div class="login-subtitle">AUTHENTICATION REQUIRED</div>
    <div class="login-box">
      <label class="login-label">Enter Access Code</label>
      <div class="pin-input-container">
        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
      </div>
      <button class="login-btn" onclick="attemptLogin()">Initialize</button>
      <div class="login-error" id="loginError">ACCESS DENIED</div>
    </div>
  </div>

  <!-- Main -->
  <div class="main-app" id="mainApp">
    <div class="header-bar">
      <div class="header-left">
        <div class="header-logo">‚öôÔ∏è</div>
        <div>
          <div class="header-title" id="greeting">Productivity Engine</div>
          <div class="header-date" id="dateInfo">Loading...</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="loadData()">üîÑ Refresh</button>
        <button class="header-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="sprint-banner" id="sprintBanner" style="display: none;">
      <div class="sprint-top">
        <div class="sprint-name" id="sprintName">‚öôÔ∏è Sprint</div>
        <div class="sprint-days" id="sprintDays">0 days</div>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="sprintProgress"></div></div>
      <div class="sprint-stats" id="sprintStats">0/0 tasks</div>
      <div class="objectives-row" id="objectivesList"></div>
    </div>

    <!-- Active -->
    <div class="section" id="activeSection">
      <div class="section-header active">
        <span class="section-title">üéØ Active</span>
        <span class="section-count" id="activeCount">0</span>
      </div>
      <div class="task-grid" id="activeTasks"><div class="loading"><div class="spinner"></div> Loading...</div></div>
    </div>

    <!-- Overdue -->
    <div class="section" id="overdueSection" style="display: none;">
      <div class="section-header overdue">
        <span class="section-title">‚ö†Ô∏è Overdue</span>
        <span class="section-count" id="overdueCount">0</span>
      </div>
      <div class="task-grid" id="overdueTasks"></div>
    </div>

    <!-- Sprint Tasks -->
    <div class="section" id="sprintTasksSection" style="display: none;">
      <div class="section-header sprint">
        <span class="section-title">üìå Sprint Queue</span>
        <span class="section-count" id="sprintTasksCount">0</span>
      </div>
      <div class="task-grid" id="sprintTasks"></div>
    </div>

    <!-- Backlog -->
    <div class="section">
      <div class="section-header">
        <span class="section-title">üìã Backlog</span>
        <span class="section-count" id="backlogCount">0</span>
      </div>
      <div class="task-grid" id="backlogTasks"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const USER_CONFIG = {
      '1987': { name: 'micaiah', api: 'https://productivity-mcp-server.micaiah-tasks.workers.dev/api' },
      '1976': { name: 'irene', api: 'https://productivity-irene.micaiah-tasks.workers.dev/api' }
    };
    let API_URL = '', API_KEY = '', currentUser = '';

    function checkSession() {
      const s = localStorage.getItem('dashboardSession');
      if (s) {
        const { pin, timestamp } = JSON.parse(s);
        if (Date.now() - timestamp < 7*24*60*60*1000 && USER_CONFIG[pin]) {
          currentUser = USER_CONFIG[pin].name;
          API_KEY = pin;
          API_URL = USER_CONFIG[pin].api;
          showMainApp();
          return true;
        }
      }
      return false;
    }

    const pinInputs = document.querySelectorAll('.pin-digit');
    pinInputs.forEach((input, i) => {
      input.addEventListener('input', e => {
        if (e.target.value && i < 3) pinInputs[i+1].focus();
      });
      input.addEventListener('keydown', e => {
        if (e.key === 'Backspace' && !e.target.value && i > 0) pinInputs[i-1].focus();
        if (e.key === 'Enter') attemptLogin();
      });
    });

    function attemptLogin() {
      const pin = Array.from(pinInputs).map(i => i.value).join('');
      if (USER_CONFIG[pin]) {
        currentUser = USER_CONFIG[pin].name;
        API_KEY = pin;
        API_URL = USER_CONFIG[pin].api;
        localStorage.setItem('dashboardSession', JSON.stringify({ pin, timestamp: Date.now() }));
        showMainApp();
      } else {
        document.getElementById('loginError').classList.add('show');
        pinInputs.forEach(input => { input.classList.add('error'); input.value = ''; });
        pinInputs[0].focus();
        setTimeout(() => {
          document.getElementById('loginError').classList.remove('show');
          pinInputs.forEach(input => input.classList.remove('error'));
        }, 2000);
      }
    }

    function showMainApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.add('visible');
      loadData();
    }

    function logout() { localStorage.removeItem('dashboardSession'); location.reload(); }

    async function api(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` };
      try {
        const r = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
        if (!r.ok) throw new Error(r.status);
        return await r.json();
      } catch (e) { console.error(e); showToast('Connection failed', 'error'); return null; }
    }

    async function loadData() {
      const data = await api('/morning');
      if (!data) return;

      const hour = new Date().getHours();
      document.getElementById('greeting').textContent = `Good ${hour < 12 ? 'Morning' : hour < 17 ? 'Afternoon' : 'Evening'}, ${currentUser}`;
      document.getElementById('dateInfo').textContent = `${data.greeting.dayOfWeek} ‚Ä¢ ${data.greeting.date}`;

      // Sprint
      if (data.sprint) {
        document.getElementById('sprintBanner').style.display = 'block';
        document.getElementById('sprintName').textContent = '‚öôÔ∏è ' + data.sprint.name;
        const daysEl = document.getElementById('sprintDays');
        daysEl.textContent = data.sprint.daysRemaining + ' days left';
        daysEl.className = 'sprint-days' + (data.sprint.daysRemaining <= 3 ? ' urgent' : data.sprint.daysRemaining <= 7 ? ' warning' : '');

        const objs = data.sprint.objectives || [];
        let total = 0, done = 0;
        objs.forEach(o => { total += o.totalTasks || 0; done += o.doneTasks || 0; });
        const pct = total > 0 ? Math.round(done/total*100) : 0;
        const prog = document.getElementById('sprintProgress');
        prog.style.width = pct + '%';
        prog.className = 'progress-fill' + (pct < 30 ? ' danger' : pct < 70 ? ' warning' : '');
        document.getElementById('sprintStats').textContent = `${done}/${total} tasks (${pct}%)`;

        document.getElementById('objectivesList').innerHTML = objs.map(o => {
          const icon = o.doneTasks === o.totalTasks && o.totalTasks > 0 ? '‚úÖ' : o.doneTasks > 0 ? '‚óê' : '‚óã';
          return `<div class="objective-chip"><span class="icon">${icon}</span><span>${esc(o.statement)}</span><span class="count">${o.doneTasks}/${o.totalTasks}</span></div>`;
        }).join('');
      } else {
        document.getElementById('sprintBanner').style.display = 'none';
      }

      // Active
      const active = data.activeTasks || [];
      document.getElementById('activeCount').textContent = active.length;
      document.getElementById('activeTasks').innerHTML = active.length === 0 
        ? '<div class="empty-state">No active tasks ‚Äî activate something below!</div>'
        : active.map(t => taskCard(t, true)).join('');

      // Overdue
      const overdue = data.overdueTasks || [];
      document.getElementById('overdueCount').textContent = overdue.length;
      document.getElementById('overdueSection').style.display = overdue.length ? 'block' : 'none';
      document.getElementById('overdueTasks').innerHTML = overdue.map(t => taskCard(t, false, true)).join('');

      // Sprint tasks (not active)
      const sprintTasks = (data.sprintTasks || []).filter(t => !t.is_active);
      document.getElementById('sprintTasksCount').textContent = sprintTasks.length;
      document.getElementById('sprintTasksSection').style.display = sprintTasks.length ? 'block' : 'none';
      document.getElementById('sprintTasks').innerHTML = sprintTasks.map(t => taskCard(t, false, false, true)).join('');

      // Backlog
      const backlog = data.backlogByCategory || {};
      const cats = Object.keys(backlog);
      let backlogTotal = 0;
      cats.forEach(c => backlogTotal += backlog[c].length);
      document.getElementById('backlogCount').textContent = backlogTotal;

      if (cats.length === 0) {
        document.getElementById('backlogTasks').innerHTML = '<div class="empty-state">Backlog empty</div>';
      } else {
        let html = '';
        cats.forEach(cat => {
          const tasks = backlog[cat];
          html += `<div class="category-label">${esc(cat)} <span class="category-count">${tasks.length}</span></div>`;
          html += tasks.map(t => taskCard(t, false)).join('');
        });
        document.getElementById('backlogTasks').innerHTML = html;
      }
    }

    function taskCard(task, isActive, isOverdue = false, inSprint = false) {
      const classes = ['task-card'];
      if (isActive) classes.push('active');
      if (isOverdue) classes.push('overdue');
      if (inSprint || task.objective_id) classes.push('in-sprint');

      let meta = '';
      if (task.due_date) {
        const od = new Date(task.due_date) < new Date(new Date().toDateString());
        meta += `<span class="task-tag due ${od ? 'overdue' : ''}">${fmtDate(task.due_date)}</span>`;
      }
      if (task.category) meta += `<span class="task-tag category">${esc(task.category)}</span>`;
      if (task.objective_statement) meta += `<span class="task-tag objective">‚Üí ${esc(task.objective_statement)}</span>`;

      return `<div class="${classes.join(' ')}" data-id="${task.id}">
        <div class="task-text">${esc(task.text)}</div>
        <div class="task-meta">${meta}</div>
        <div class="task-actions">
          ${isActive 
            ? `<button class="task-btn deactivate" onclick="deactivate('${task.id}')">‚àí Remove</button>`
            : `<button class="task-btn activate" onclick="activate('${task.id}')">‚òÖ Activate</button>`}
          <button class="task-btn complete" onclick="complete('${task.id}', this)">‚úì Done</button>
        </div>
      </div>`;
    }

    async function complete(id, btn) {
      btn.classList.add('completing');
      btn.innerHTML = '...';
      const r = await api(`/tasks/${id}/complete`, { method: 'POST' });
      if (r?.success) { showToast('Completed ‚úì'); setTimeout(loadData, 400); }
      else { btn.classList.remove('completing'); btn.innerHTML = '‚úì Done'; }
    }

    async function activate(id) {
      const r = await api(`/tasks/${id}/activate`, { method: 'POST' });
      if (r?.success) { showToast('Activated'); loadData(); }
    }

    async function deactivate(id) {
      const r = await api(`/tasks/${id}/deactivate`, { method: 'POST' });
      if (r?.success) { showToast('Deactivated'); loadData(); }
    }

    function fmtDate(d) { return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
    function esc(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }
    function showToast(msg, type='success') { const t = document.getElementById('toast'); t.textContent = msg; t.className = `toast show ${type}`; setTimeout(() => t.classList.remove('show'), 3000); }

    if (!checkSession()) pinInputs[0].focus();
  </script>
</body>
</html>